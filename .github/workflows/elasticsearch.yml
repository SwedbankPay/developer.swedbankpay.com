name: Jekyll Build and Elasticsearch Indexing

on:
  push:
    branches: ['index-to-elasticsearch']

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Jekyll Build
        run: |
          docker compose run \
            -e GITHUB_BRANCH=index-to-elasticsearch \
            -e GITHUB_REPOSITORY_URL=https://github.com/SwedbankPay/developer.swedbankpay.com \
            portal build \
            --env=production \
            --site-url=https://developer-ecom.stage.swedbankpay.com

      # Debugging Step: List files in _site
      - name: List files in _site
        run: |
          ls -la ./_site

      # If all_content.html is missing, copy it manually
      - name: Copy all_content.html to _site
        if: !contains(steps.list-files.outputs.stdout, 'all_content.html')
        run: |
          cp all_content.html ./_site/

      - name: Install wkhtmltopdf
        run: |
          sudo apt-get update
          sudo apt-get install -y wkhtmltopdf

      - name: Generate PDF
        working-directory: ./_site
        run: |
          wkhtmltopdf --enable-local-file-access "file://$(pwd)/all_content.html" full_site.pdf

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Upload PDF to Azure Storage
        run: |
          az storage blob upload \
            --container-name pdf \
            --file "_site/full_site.pdf" \
            --name "full_site.pdf" \
            --account-name stagedeveloperecomsa2 \
            --overwrite
