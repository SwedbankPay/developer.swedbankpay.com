{% capture features_url %}{% include utils/documentation-section-url.md href='/features' %}{% endcapture %}
{%- capture documentation_section -%}{%- include utils/documentation-section.md -%}{%- endcapture -%}
{% assign operation_status_bool = include.operation_status_bool | default: "false" %}
{% capture api_resource %}{% include api-resource.md %}{% endcapture %}
{% assign implementation = documentation_section | split: "/" | last | capitalize | remove: "-" %}

## What Is Network Tokenization?

The reason behind network tokenization is to shift the processing of stored
cards from card numbers (PAN) to tokens. Card details are replaced by the token
and a cryptogram.

The tokens are generated by the card networks (Visa and MasterCard) when an
end-user signs up for a service using a stored card. Tokens are global within
the network, where Merchants, PSPs and issuers can connect to them. The merchant
and PSP are provided with the token attached to a card, while the issuer is able
to update the card information attached to the token. The result is a token
which lives after a card expires, since the card information connected to it is
updated seamlessly by the issuer.

This will improve the user experience for the end-user, as they no longer have
to take action when their card reaches the expiry date. As the card connected to
the token will be valid at all times, this will reduce churn and improve
approval rates for merchants and PSPs as well, especially for subscription and
one-click services.

## How It Works

This functionality is available through both our
[payment order implementations][payment-order] and [card implementation][card]
for [recurring transactions][recur], [one-click][one-click] and
[unscheduled purchases][unscheduled]. We strongly recommend `paymentOrder` to
ensure that you get access to capabilities coming in later deliveries, such as
card art, shared tokens and notifications. It is only available with Swedbank
Pay as acquirer for the time being.

When you choose to add this functionality, we activate Network Tokenization for
your merchant account and initiate onboarding towards VISA and Mastercard. Once
we get onboarding confirmation from Visa and Mastercard, Network Tokenization
will be enabled and used for future card storage and stored card processing.
Cards that have previously been stored with card details only, will be network
tokenized next time they are charged.

Once the setup is completed, the transactions themselves run as normal
unscheduled, one-click or recurring purchases. The difference is that Network
Tokenization replaces the card number behind the token.

Do you want to give it a go? Test cards and a guide is in the
[test data][test-data] section.

## Recommendations To You As A Merchant

*   If you are displaying the last four digits of your customers stored cards,
    we highly recommend refreshing these numbers when a card has been updated or
    replaced by the issuer. This would help the customer to understand that a
    new and valid card is stored. It is also recommended that you add
    information that the card has been updated automatically by the issuer.
    Retrieving the updated card information is done using `payerOwnedTokens`,
    and should be done when the end-user logs in, goes to “My cards” or at a
    similar point that makes sense in your portal.

The `GET` request to retrieve updated card information should look similar to
this.

{% capture request_header %}GET /psp/paymentorders/payerownedtokens/<payerReference> HTTP/1.1
Host: {{ page.api_host }}
Authorization: Bearer <AccessToken>
Content-Type: application/json;version=3.x/2.0      // Version optional for 3.0 and 2.0 {% endcapture %}

{% include code-example.html
    title='GET Tokens Request'
    header=request_header
    %}

{% capture response_header %}HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8; version=3.x/2.0
api-supported-versions: 3.x/2.0{% endcapture %}

{% capture response_content %}{
  "payerOwnedTokens": {
        "id": "/psp/paymentorders/payerownedtokens/{payerReference}",
        "payerReference": "{payerReference}",
        "tokens": [
            {
                "token": "{token}",
                "tokenType": "Unscheduled",
                "instrument": "CreditCard",
                "instrumentDisplayName": "492500******0004",
                "correlationId": "e2f06785-805d-4605-bf40-426a725d313d",
                "instrumentParameters": {
                    "expiryDate": "12/2025",
                    "cardBrand": "Visa",
                    "lastFourPan": "0004",
                    "lastFourDPan": "8188",
                    "issuerName": "BankName"
                },
                "operations": [
                    {
                        "method": "PATCH",
                        "href": "https://api.internaltest.payex.com/psp/paymentorders/unscheduledtokens/e2f06785-805d-4605-bf40-426a725d313d",
                        "rel": "delete-unscheduledtokens",
                        "contentType": "application/json"
                    }
                ]
            }
        ]
    },
    "operations": [
        {
            "method": "PATCH",
            "href": "https://api.internaltest.payex.com/psp/paymentorders/payerOwnedPaymentTokens/{payerReference}",
            "rel": "delete-payerownedtokens",
            "contentType": "application/json"
        }
    ]
}{% endcapture %}

{% include code-example.html
    title='GET Tokens Response'
    header=response_header
    json= response_content
    %}

{:.table .table-striped .mb-5}
| Field                          | Type      | Description    |
| :----------------------------- | :-------- | :------------------- |
| {% f instrumentParameters %}   | `integer` | A list of additional information connected to the token. Depending on the payment method, it can e.g. be `expiryDate`, `cardBrand`, `email`, `msisdn` or `zipCode`.|
| {% f expiryDate, 2 %}      | `string`  | The expiry date of the card currently connected to the network token.                                  |
| {% f cardBrand, 2 %}                 | `string` | The brand of the card currently connected to the network token.                                          |
| {% f lastFourPan, 2 %}               | `string`  | The last four digits of the PAN connected to the network token. |
| {% f lastFourDpan, 2 %}                 | `string` | The last four digits of the DPAN (Network Token).                                           |
| {% f issuerName, 2 %}               | `string`  | The name of the issuer. |

*   We advise you to implement automatic deletion of tokens when end-users
choose to end the service with the you. This is to avoid unnecessary cost on
your end, as you are invoiced monthly for each active token.

*   Please note that the new field `maskedDpan` is present when using Network
Tokenization. DPAN is the network token representing the card and thus,
`maskedDpan` is a masked version of the network token. It will only appear if
the card is tokenized by Visa or Mastercard. The end-user will not normally know
what `maskedDpan` is or that it’s being used, but you as a merchant need to keep
track of it. See the [Paid resource for cards][paid-resource-model].

[card]: https://developer.swedbankpay.com/old-implementations/payment-instruments-v1/card/
[paid-resource-model]: https://developer.swedbankpay.com/checkout-v3/technical-reference/resource-sub-models#card-paid-resource
[one-click]: https://developer.swedbankpay.com/checkout-v3/features/optional/one-click
[unscheduled]: https://developer.swedbankpay.com/checkout-v3/features/optional/unscheduled
[recur]: https://developer.swedbankpay.com/checkout-v3/features/optional/recur
[payment-order]: /checkout-v3/get-started/payment-request
[test-data]: https://developer.swedbankpay.com/checkout-v3/test-data/network-tokenization
